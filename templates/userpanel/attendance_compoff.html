{% extends 'userpanel/base_user.html' %}
{% load static %}

{% block title %}Sunday Comp-Off{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="zoho-page-header" data-aos="fade-down">
    <div>
        <h1 class="zoho-page-title">Sunday Comp-Off Information</h1>
        <p class="zoho-page-subtitle">Log Sunday work and claim compensatory off</p>
    </div>
    <button class="zoho-btn zoho-btn-primary" onclick="openAddCompoffForm()">
        <i class="bi bi-plus-lg"></i>
        Add Comp-Off
    </button>
</div>

<!-- Month Navigation & Stats -->
<div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; margin-bottom: 24px;" data-aos="fade-up" data-aos-delay="100">
    <div class="month-nav">
        <button class="month-nav-btn" onclick="navigateMonth({{ year }}, {{ month }}, -1)">
            <i class="bi bi-chevron-left"></i>
        </button>
        <div class="month-nav-current">{{ month_name }} {{ year }}</div>
        <button class="month-nav-btn" onclick="navigateMonth({{ year }}, {{ month }}, 1)" {% if is_current_month %}disabled{% endif %}>
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>
    
    <div style="display: flex; gap: 12px;">
        <div class="zoho-stat-card" style="padding: 10px 16px;">
            <div class="zoho-stat-icon blue" style="width: 32px; height: 32px; font-size: 14px;">
                <i class="bi bi-calendar-plus"></i>
            </div>
            <div>
                <div class="zoho-stat-value" style="font-size: 18px;">{{ stats.total }}</div>
                <div class="zoho-stat-label" style="font-size: 10px;">Total</div>
            </div>
        </div>
        <div class="zoho-stat-card" style="padding: 10px 16px;">
            <div class="zoho-stat-icon green" style="width: 32px; height: 32px; font-size: 14px;">
                <i class="bi bi-check-circle"></i>
            </div>
            <div>
                <div class="zoho-stat-value" style="font-size: 18px;">{{ stats.approved }}</div>
                <div class="zoho-stat-label" style="font-size: 10px;">Approved</div>
            </div>
        </div>
        <div class="zoho-stat-card" style="padding: 10px 16px;">
            <div class="zoho-stat-icon yellow" style="width: 32px; height: 32px; font-size: 14px;">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div>
                <div class="zoho-stat-value" style="font-size: 18px;">{{ stats.pending }}</div>
                <div class="zoho-stat-label" style="font-size: 10px;">Pending</div>
            </div>
        </div>
    </div>
</div>

<!-- Comp-Off Table -->
<div class="zoho-table-wrapper" data-aos="fade-up" data-aos-delay="200">
    <div class="zoho-table-toolbar">
        <div class="zoho-search-box">
            <i class="bi bi-search"></i>
            <input type="text" class="zoho-search-input" placeholder="Search..." onkeyup="searchTable(this.value)">
        </div>
        <div class="zoho-filter-group">
            <button class="zoho-btn zoho-btn-secondary" style="padding: 8px 12px;" onclick="resetColumnOrder()" title="Reset Column Order">
                <i class="bi bi-arrow-counterclockwise"></i>
            </button>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table class="zoho-table" id="compoffTable">
            <thead>
                <tr>
                    <th data-column="sno" data-draggable="false" style="width: 60px;">S.No</th>
                    <th data-column="sunday_date">Sunday Date</th>
                    <th data-column="work_purpose">Work Purpose</th>
                    <th data-column="compoff_date">Comp-Off Date</th>
                    <th data-column="status">Status</th>
                    <th data-column="action" data-draggable="false" style="width: 150px;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for compoff in compoffs %}
                <tr data-id="{{ compoff.ID }}">
                    <td data-column="sno">{{ forloop.counter }}</td>
                    <td data-column="sunday_date">
                        <span style="color: var(--zoho-accent); font-weight: 500;">{{ compoff.SUNDAY_DATE|date:"d M, Y" }}</span>
                        <span style="font-size: 11px; color: var(--zoho-text-muted); display: block;">Sunday</span>
                    </td>
                    <td data-column="work_purpose">{{ compoff.WORK_PURPOSE|truncatechars:40 }}</td>
                    <td data-column="compoff_date">
                        {% if compoff.NO_COMPOFF %}
                        <span style="color: var(--zoho-text-muted);">No Comp-Off</span>
                        {% elif compoff.COMPOFF_DATE %}
                        {{ compoff.COMPOFF_DATE|date:"d M, Y" }}
                        {% else %}
                        <span style="color: var(--zoho-text-muted);">-</span>
                        {% endif %}
                    </td>
                    <td data-column="status">
                        {% if compoff.IS_APPROVED == 1 %}
                        <span class="status-badge approved"><i class="bi bi-check-circle"></i> Approved</span>
                        {% elif compoff.IS_APPROVED == 0 %}
                        <span class="status-badge rejected"><i class="bi bi-x-circle"></i> Rejected</span>
                        {% else %}
                        <span class="status-badge pending"><i class="bi bi-hourglass-split"></i> Pending</span>
                        {% endif %}
                    </td>
                    <td data-column="action">
                        <div class="action-buttons">
                            <button class="zoho-action-btn edit" onclick="viewCompoff({{ compoff.ID }})" title="View">
                                <i class="bi bi-eye"></i>
                            </button>
                            {% if compoff.IS_APPROVED is None %}
                            <button class="zoho-action-btn edit" onclick="editCompoff({{ compoff.ID }})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="zoho-action-btn delete" onclick="confirmDeleteCompoff({{ compoff.ID }})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">
                        <div class="zoho-empty-state">
                            <div class="zoho-empty-icon">
                                <i class="bi bi-calendar-plus"></i>
                            </div>
                            <h3 class="zoho-empty-title">No Comp-Off Records</h3>
                            <p class="zoho-empty-text">You haven't submitted any comp-off requests for {{ month_name }}.</p>
                            <button class="zoho-btn zoho-btn-primary" onclick="openAddCompoffForm()">
                                <i class="bi bi-plus-lg"></i>
                                Add Comp-Off Request
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}
.status-badge.approved { background: rgba(16, 185, 129, 0.15); color: var(--zoho-neon-green); }
.status-badge.rejected { background: rgba(239, 68, 68, 0.15); color: var(--zoho-neon-red); }
.status-badge.pending { background: rgba(245, 158, 11, 0.15); color: var(--zoho-neon-yellow); }
.action-buttons { display: flex; gap: 6px; }

.form-hint {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 6px;
    font-size: 11px;
    color: var(--zoho-text-muted);
}

.compoff-date-section {
    display: flex;
    gap: 16px;
    margin-bottom: 8px;
}

.compoff-option {
    display: flex;
    align-items: center;
    gap: 6px;
}

.compoff-option input[type="radio"] {
    width: 16px;
    height: 16px;
    accent-color: var(--zoho-accent);
    cursor: pointer;
}

.compoff-option label {
    font-size: 13px;
    color: var(--zoho-text-secondary);
    cursor: pointer;
}

.compoff-option input[type="radio"]:checked + label {
    color: var(--zoho-text-primary);
    font-weight: 500;
}

input[type="date"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: var(--zoho-bg-secondary);
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/draggable-table.js' %}"></script>
<script>
const compoffDates = {{ compoff_dates|safe }};

let compoffTable;
document.addEventListener('DOMContentLoaded', function() {
    compoffTable = initDraggableTable('compoffTable', 'compoff');
});

function resetColumnOrder() {
    if (compoffTable) compoffTable.resetOrder();
}

function openAddCompoffForm() {
    const today = new Date().toISOString().split('T')[0];
    
    const formHtml = `
        <form id="compoffForm" class="zoho-form">
            <input type="hidden" name="id" value="">
            
            <div class="zoho-form-group">
                <label class="zoho-form-label required">Sunday Date (Worked)</label>
                <input type="date" name="sunday_date" id="sundayDateInput" class="zoho-form-input" required onchange="validateSunday(this)">
                <small class="form-hint"><i class="bi bi-info-circle"></i> Select the Sunday you worked on</small>
            </div>
            
            <div class="zoho-form-group">
                <label class="zoho-form-label required">Work Purpose</label>
                <input type="text" name="work_purpose" class="zoho-form-input" placeholder="What did you work on?" required>
            </div>
            
            <div class="zoho-form-group">
                <label class="zoho-form-label">Comp-Off Date</label>
                <div class="compoff-date-section">
                    <div class="compoff-option">
                        <input type="radio" name="compoff_choice" id="chooseDate" value="date" checked onchange="toggleCompoffDate()">
                        <label for="chooseDate">Select a date</label>
                    </div>
                    <div class="compoff-option">
                        <input type="radio" name="compoff_choice" id="noCompoff" value="none" onchange="toggleCompoffDate()">
                        <label for="noCompoff">No Comp-Off Required</label>
                    </div>
                </div>
                <input type="date" name="compoff_date" id="compoffDateInput" class="zoho-form-input" min="${today}" style="margin-top: 8px;">
                <small class="form-hint"><i class="bi bi-info-circle"></i> Select the date you want to take comp-off</small>
            </div>
            
            <div class="zoho-form-group">
                <label class="zoho-form-label">Notes</label>
                <textarea name="notes" class="zoho-form-input" rows="3" placeholder="Additional notes (optional)"></textarea>
            </div>
            
            <div class="zoho-btn-group" style="margin-top: 24px;">
                <button type="submit" class="zoho-btn zoho-btn-primary">
                    <i class="bi bi-send"></i>
                    Send Info
                </button>
                <button type="button" class="zoho-btn zoho-btn-secondary" onclick="closeSlidePanel()">
                    Cancel
                </button>
            </div>
        </form>
    `;
    
    openSlidePanel('Add Comp-Off Request', formHtml);
    
    setTimeout(() => {
        document.getElementById('compoffForm').addEventListener('submit', handleCompoffSubmit);
    }, 100);
}

function toggleCompoffDate() {
    const chooseDate = document.getElementById('chooseDate');
    const compoffDateInput = document.getElementById('compoffDateInput');
    
    if (chooseDate && compoffDateInput) {
        compoffDateInput.disabled = !chooseDate.checked;
        if (!chooseDate.checked) {
            compoffDateInput.value = '';
        }
    }
}

function validateSunday(input) {
    const date = new Date(input.value);
    if (date.getDay() !== 0) {
        Swal.fire({
            title: 'Invalid Date',
            text: 'Please select a Sunday',
            icon: 'warning',
            customClass: { popup: 'zoho-swal' }
        });
        input.value = '';
    }
}

function editCompoff(compoffId) {
    showLoader();
    
    fetch(`/user/attendance/compoff/${compoffId}/`)
        .then(response => response.json())
        .then(data => {
            hideLoader();
            if (data.success) {
                const compoff = data.compoff;
                const today = new Date().toISOString().split('T')[0];
                const isNoCompoff = compoff.no_compoff;
                
                const formHtml = `
                    <form id="compoffForm" class="zoho-form">
                        <input type="hidden" name="id" value="${compoff.id}">
                        
                        <div class="zoho-form-group">
                            <label class="zoho-form-label required">Sunday Date (Worked)</label>
                            <input type="date" name="sunday_date" id="sundayDateInput" class="zoho-form-input" required value="${compoff.sunday_date}" onchange="validateSunday(this)">
                            <small class="form-hint"><i class="bi bi-info-circle"></i> Select the Sunday you worked on</small>
                        </div>
                        
                        <div class="zoho-form-group">
                            <label class="zoho-form-label required">Work Purpose</label>
                            <input type="text" name="work_purpose" class="zoho-form-input" required value="${escapeHtml(compoff.work_purpose)}">
                        </div>
                        
                        <div class="zoho-form-group">
                            <label class="zoho-form-label">Comp-Off Date</label>
                            <div class="compoff-date-section">
                                <div class="compoff-option">
                                    <input type="radio" name="compoff_choice" id="chooseDate" value="date" ${!isNoCompoff ? 'checked' : ''} onchange="toggleCompoffDate()">
                                    <label for="chooseDate">Select a date</label>
                                </div>
                                <div class="compoff-option">
                                    <input type="radio" name="compoff_choice" id="noCompoff" value="none" ${isNoCompoff ? 'checked' : ''} onchange="toggleCompoffDate()">
                                    <label for="noCompoff">No Comp-Off Required</label>
                                </div>
                            </div>
                            <input type="date" name="compoff_date" id="compoffDateInput" class="zoho-form-input" min="${today}" value="${compoff.compoff_date || ''}" ${isNoCompoff ? 'disabled' : ''} style="margin-top: 8px;">
                            <small class="form-hint"><i class="bi bi-info-circle"></i> Select the date you want to take comp-off</small>
                        </div>
                        
                        <div class="zoho-form-group">
                            <label class="zoho-form-label">Notes</label>
                            <textarea name="notes" class="zoho-form-input" rows="3">${escapeHtml(compoff.notes)}</textarea>
                        </div>
                        
                        <div class="zoho-btn-group" style="margin-top: 24px;">
                            <button type="submit" class="zoho-btn zoho-btn-primary">
                                <i class="bi bi-check-lg"></i>
                                Update
                            </button>
                            <button type="button" class="zoho-btn zoho-btn-secondary" onclick="closeSlidePanel()">
                                Cancel
                            </button>
                        </div>
                    </form>
                `;
                
                openSlidePanel('Edit Comp-Off Request', formHtml);
                setTimeout(() => {
                    document.getElementById('compoffForm').addEventListener('submit', handleCompoffSubmit);
                }, 100);
            }
        });
}

function viewCompoff(compoffId) {
    showLoader();
    
    fetch(`/user/attendance/compoff/${compoffId}/`)
        .then(response => response.json())
        .then(data => {
            hideLoader();
            if (data.success) {
                const compoff = data.compoff;
                const statusClass = compoff.is_approved === 1 ? 'approved' : (compoff.is_approved === 0 ? 'rejected' : 'pending');
                
                const viewHtml = `
                    <div class="log-view-header">
                        <div class="log-view-icon" style="background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);">
                            <i class="bi bi-calendar-plus"></i>
                        </div>
                        <div class="log-view-title">
                            <h4>Sunday Work - ${compoff.sunday_date_display}</h4>
                            <p>${compoff.work_purpose}</p>
                        </div>
                    </div>
                    
                    <div class="log-view-meta">
                        <div class="log-view-meta-item">
                            <div class="log-view-meta-label">Comp-Off Date</div>
                            <div class="log-view-meta-value">${compoff.compoff_date_display}</div>
                        </div>
                        <div class="log-view-meta-item">
                            <div class="log-view-meta-label">Status</div>
                            <div class="log-view-meta-value">
                                <span class="status-badge ${statusClass}">${compoff.status}</span>
                            </div>
                        </div>
                        <div class="log-view-meta-item">
                            <div class="log-view-meta-label">Requested</div>
                            <div class="log-view-meta-value">${compoff.requested_at}</div>
                        </div>
                    </div>
                    
                    ${compoff.notes ? `
                    <div class="log-view-content">
                        <div class="log-view-content-label">Notes</div>
                        <div class="log-view-content-text">${escapeHtml(compoff.notes)}</div>
                    </div>
                    ` : ''}
                `;
                
                openSlidePanel('Comp-Off Details', viewHtml);
            }
        });
}

function handleCompoffSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    const compoffChoice = formData.get('compoff_choice');
    const compoffDateValue = formData.get('compoff_date');
    const isNoCompoff = compoffChoice === 'none';
    
    const data = {
        id: formData.get('id') || null,
        sunday_date: formData.get('sunday_date'),
        work_purpose: formData.get('work_purpose'),
        compoff_date: isNoCompoff ? null : compoffDateValue,
        no_compoff: isNoCompoff,
        notes: formData.get('notes')
    };
    
    // Validation
    if (!isNoCompoff && !compoffDateValue) {
        Swal.fire({
            title: 'Missing Date',
            text: 'Please select a comp-off date or choose "No Comp-Off Required"',
            icon: 'warning',
            customClass: { popup: 'zoho-swal' }
        });
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
    
    fetch('/user/attendance/compoff/save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeSlidePanel();
            Swal.fire({
                title: 'Success!',
                text: data.message,
                icon: 'success',
                customClass: { popup: 'zoho-swal' }
            }).then(() => location.reload());
        } else {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-send"></i> Send Info';
            Swal.fire({
                title: 'Error',
                html: data.errors ? data.errors.join('<br>') : data.error,
                icon: 'error',
                customClass: { popup: 'zoho-swal' }
            });
        }
    });
}

function confirmDeleteCompoff(compoffId) {
    Swal.fire({
        title: 'Delete Comp-Off Request?',
        text: 'This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Delete',
        customClass: { popup: 'zoho-swal' }
    }).then((result) => {
        if (result.isConfirmed) {
            showLoader();
            fetch(`/user/attendance/compoff/${compoffId}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                hideLoader();
                if (data.success) {
                    Swal.fire({ title: 'Deleted!', text: data.message, icon: 'success', customClass: { popup: 'zoho-swal' } })
                        .then(() => location.reload());
                } else {
                    Swal.fire({ title: 'Error', text: data.error, icon: 'error', customClass: { popup: 'zoho-swal' } });
                }
            });
        }
    });
}

function searchTable(query) {
    const rows = document.querySelectorAll('#compoffTable tbody tr');
    query = query.toLowerCase();
    rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(query) ? '' : 'none';
    });
}

function navigateMonth(year, month, direction) {
    let newMonth = month + direction;
    let newYear = year;
    if (newMonth > 12) { newMonth = 1; newYear++; }
    else if (newMonth < 1) { newMonth = 12; newYear--; }
    window.location.href = `?year=${newYear}&month=${newMonth}`;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
