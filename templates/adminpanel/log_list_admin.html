{% extends 'adminpanel/base_admin.html' %}
{% load static %}

{% block title %}Log Management{% endblock %}

{% block content %}
<div class="zoho-page-header" data-aos="fade-down">
    <div><h1 class="zoho-page-title">Log Management</h1><p class="zoho-page-subtitle">View all user logs</p></div>
</div>

<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;margin-bottom:24px;" data-aos="fade-up">
    <div class="month-nav">
        <button class="month-nav-btn" onclick="navigateMonth({{year}},{{month}},-1)"><i class="bi bi-chevron-left"></i></button>
        <div class="month-nav-current">{{ month_name }} {{ year }}</div>
        <button class="month-nav-btn" onclick="navigateMonth({{year}},{{month}},1)" {% if is_current_month %}disabled{% endif %}><i class="bi bi-chevron-right"></i></button>
    </div>
    <div style="display:flex;gap:12px;">
        <div class="zoho-stat-card" style="padding:10px 16px;"><div class="zoho-stat-icon blue" style="width:32px;height:32px;font-size:14px;"><i class="bi bi-journal-text"></i></div><div><div class="zoho-stat-value" style="font-size:18px;">{{ stats.total }}</div><div class="zoho-stat-label" style="font-size:10px;">Total</div></div></div>
        <div class="zoho-stat-card" style="padding:10px 16px;"><div class="zoho-stat-icon green" style="width:32px;height:32px;font-size:14px;"><i class="bi bi-sun"></i></div><div><div class="zoho-stat-value" style="font-size:18px;">{{ stats.first_half }}</div><div class="zoho-stat-label" style="font-size:10px;">First Half</div></div></div>
        <div class="zoho-stat-card" style="padding:10px 16px;"><div class="zoho-stat-icon purple" style="width:32px;height:32px;font-size:14px;"><i class="bi bi-moon"></i></div><div><div class="zoho-stat-value" style="font-size:18px;">{{ stats.second_half }}</div><div class="zoho-stat-label" style="font-size:10px;">Second Half</div></div></div>
    </div>
</div>

<div class="zoho-table-wrapper" data-aos="fade-up" data-aos-delay="100">
    <div class="zoho-table-toolbar">
        <div class="zoho-search-box"><i class="bi bi-search"></i><input type="text" class="zoho-search-input" placeholder="Search..." onkeyup="searchAdminTable(this.value,'logTable')"></div>
        <button class="zoho-btn zoho-btn-secondary" style="padding:8px 12px;" onclick="logTable.resetOrder()"><i class="bi bi-arrow-counterclockwise"></i></button>
    </div>
    <div style="overflow-x:auto;">
        <table class="zoho-table" id="logTable">
            <thead><tr>
                <th data-col="sno" data-draggable="false" style="width:50px;">S.No</th>
                <th data-col="user">User</th>
                <th data-col="project">Project</th>
                <th data-col="heading">Heading</th>
                <th data-col="date">Date</th>
                <th data-col="session">Session</th>
                <th data-col="created">Created At</th>
                <th data-col="action" data-draggable="false" style="width:80px;">Action</th>
            </tr></thead>
            <tbody>
            {% for log in logs %}
            <tr>
                <td data-col="sno">{{ forloop.counter }}</td>
                <td data-col="user"><div style="font-weight:500;">{{ log.EMP_NAME }}</div><div style="font-size:11px;color:var(--zoho-text-muted);">{{ log.EMP_ID }}</div></td>
                <td data-col="project"><span style="color:var(--zoho-accent);font-weight:500;">{{ log.PROJECT_TITLE|truncatechars:25 }}</span></td>
                <td data-col="heading">{{ log.LOG_HEADING|truncatechars:35 }}</td>
                <td data-col="date">{{ log.LOG_DATE|date:"d M, Y" }}</td>
                <td data-col="session"><span class="session-badge {% if log.SESSION_TYPE == 'First Half' %}first{% else %}second{% endif %}">{{ log.SESSION_TYPE }}</span></td>
                <td data-col="created">{{ log.CREATED_AT|date:"d M, H:i" }}</td>
                <td data-col="action">
                    <button class="action-btn view" onclick="viewLogAdmin({{log.ID}})"><i class="bi bi-eye"></i></button>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="8"><div class="zoho-empty-state"><div class="zoho-empty-icon"><i class="bi bi-journal-x"></i></div><h3 class="zoho-empty-title">No Log Records</h3></div></td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% include 'adminpanel/_slide_panel.html' %}
{% endblock %}

{% block extra_css %}
<style>
.session-badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:500;}
.session-badge.first{background:rgba(59,130,246,0.15);color:#3b82f6;}
.session-badge.second{background:rgba(139,92,246,0.15);color:#8b5cf6;}
.action-btn{width:28px;height:28px;border:none;border-radius:6px;background:transparent;color:var(--zoho-text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;}
.action-btn:hover{background:var(--zoho-bg-hover);}
.action-btn.view:hover{color:#3b82f6;}
.month-nav{display:flex;align-items:center;gap:16px;}
.month-nav-btn{width:36px;height:36px;border-radius:6px;border:1px solid var(--zoho-border);background:var(--zoho-bg-secondary);color:var(--zoho-text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;}
.month-nav-btn:hover:not(:disabled){background:var(--zoho-bg-hover);}
.month-nav-btn:disabled{opacity:0.5;cursor:not-allowed;}
.month-nav-current{font-size:16px;font-weight:600;min-width:150px;text-align:center;}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/admin-tables.js' %}"></script>
<script>
const csrfToken = '{{ csrf_token }}';
let logTable;
document.addEventListener('DOMContentLoaded', function() { logTable = new AdminDraggableTable('logTable', 'log'); });

function navigateMonth(year, month, direction) {
    month += direction;
    if (month < 1) { month = 12; year--; }
    if (month > 12) { month = 1; year++; }
    window.location.href = `?year=${year}&month=${month}`;
}

function searchAdminTable(query, tableId) {
    const table = document.getElementById(tableId);
    const rows = table.querySelectorAll('tbody tr');
    query = query.toLowerCase();
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });
}

function viewLogAdmin(id) {
    // Open slide panel with log details
    fetch(`/adminpanel/api/log/${id}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const log = data.log;
                document.getElementById('slidePanel').innerHTML = `
                    <div class="slide-panel-header">
                        <h3>Log Details</h3>
                        <button class="slide-panel-close" onclick="closeSlidePanel()"><i class="bi bi-x-lg"></i></button>
                    </div>
                    <div class="slide-panel-body">
                        <div class="detail-group"><label>Employee</label><p>${log.EMP_NAME} (${log.EMP_ID})</p></div>
                        <div class="detail-group"><label>Project</label><p>${log.PROJECT_TITLE}</p></div>
                        <div class="detail-group"><label>Heading</label><p>${log.LOG_HEADING}</p></div>
                        <div class="detail-group"><label>Date</label><p>${log.LOG_DATE}</p></div>
                        <div class="detail-group"><label>Session</label><p>${log.SESSION_TYPE}</p></div>
                        <div class="detail-group"><label>Description</label><div class="log-content">${log.LOG_DESCRIPTION || '-'}</div></div>
                    </div>
                `;
                openSlidePanel();
            }
        });
}
</script>
{% endblock %}
