{% extends 'userpanel/base_user.html' %}
{% load static %}

{% block title %}Log Management{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="zoho-page-header" data-aos="fade-down">
    <div>
        <h1 class="zoho-page-title">Log Management</h1>
        <p class="zoho-page-subtitle">Manage your daily work logs</p>
    </div>
    {% if is_current_month %}
    <button class="zoho-btn zoho-btn-primary" onclick="openAddLogForm('{{ current_date }}', '{{ current_date_display }}')">
        <i class="bi bi-plus-lg"></i>
        Add Log
    </button>
    {% endif %}
</div>

<!-- Month Navigation & Stats -->
<div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; margin-bottom: 24px;" data-aos="fade-up" data-aos-delay="100">
    <div class="month-nav">
        <button class="month-nav-btn" onclick="navigateMonth({{ year }}, {{ month }}, -1)">
            <i class="bi bi-chevron-left"></i>
        </button>
        <div class="month-nav-current">{{ month_name }} {{ year }}</div>
        <button class="month-nav-btn" onclick="navigateMonth({{ year }}, {{ month }}, 1)" {% if is_current_month %}disabled{% endif %}>
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>
    
    <div style="display: flex; gap: 16px;">
        <div class="zoho-stat-card" style="padding: 12px 20px;">
            <div class="zoho-stat-icon blue" style="width: 36px; height: 36px; font-size: 16px;">
                <i class="bi bi-journal-text"></i>
            </div>
            <div>
                <div class="zoho-stat-value" style="font-size: 20px;">{{ stats.total_logs }}</div>
                <div class="zoho-stat-label" style="font-size: 11px;">Total</div>
            </div>
        </div>
        <div class="zoho-stat-card" style="padding: 12px 20px;">
            <div class="zoho-stat-icon green" style="width: 36px; height: 36px; font-size: 16px;">
                <i class="bi bi-sun"></i>
            </div>
            <div>
                <div class="zoho-stat-value" style="font-size: 20px;">{{ stats.first_half_count }}</div>
                <div class="zoho-stat-label" style="font-size: 11px;">First Half</div>
            </div>
        </div>
        <div class="zoho-stat-card" style="padding: 12px 20px;">
            <div class="zoho-stat-icon purple" style="width: 36px; height: 36px; font-size: 16px;">
                <i class="bi bi-moon"></i>
            </div>
            <div>
                <div class="zoho-stat-value" style="font-size: 20px;">{{ stats.second_half_count }}</div>
                <div class="zoho-stat-label" style="font-size: 11px;">Second Half</div>
            </div>
        </div>
    </div>
</div>

<!-- Time Window Info (Only for current month) -->
{% if is_current_month %}
<div class="zoho-alert info" data-aos="fade-up" data-aos-delay="150">
    <i class="bi bi-info-circle zoho-alert-icon"></i>
    <div class="zoho-alert-content">
        <div class="zoho-alert-title">Submission Time Windows</div>
        <div class="zoho-alert-text">
            <strong>First Half:</strong> 1:00 PM - 2:30 PM IST &nbsp;|&nbsp; 
            <strong>Second Half:</strong> 6:00 PM - 7:30 PM IST &nbsp;|&nbsp;
            <strong>Current Time:</strong> {{ time_info.current_time_display }}
            {% if time_info.first_half_allowed %}
                <span style="color: var(--zoho-neon-green); margin-left: 8px;">
                    <i class="bi bi-check-circle"></i> First Half window open
                </span>
            {% elif time_info.second_half_allowed %}
                <span style="color: var(--zoho-neon-green); margin-left: 8px;">
                    <i class="bi bi-check-circle"></i> Second Half window open
                </span>
            {% else %}
                <span style="color: var(--zoho-neon-yellow); margin-left: 8px;">
                    <i class="bi bi-exclamation-triangle"></i> Outside submission window (approval required)
                </span>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Logs Table -->
<div class="zoho-table-wrapper" data-aos="fade-up" data-aos-delay="200">
    <div class="zoho-table-toolbar">
        <div class="zoho-search-box">
            <i class="bi bi-search"></i>
            <input type="text" class="zoho-search-input" placeholder="Search logs...">
        </div>
        <div class="zoho-filter-group">
            <span style="font-size: 13px; color: var(--zoho-text-muted);">
                {{ logs|length }} log{% if logs|length != 1 %}s{% endif %} in {{ month_name }}
            </span>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table class="zoho-table" id="logsTable">
            <thead>
                <tr>
                    <th data-column="sno" data-draggable="false" style="width: 60px;">S.No</th>
                    <th data-column="project">Project</th>
                    <th data-column="heading">Heading</th>
                    <th data-column="date">Date</th>
                    <th data-column="session">Session</th>
                    <th data-column="action" data-draggable="false" style="width: 100px;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr data-aos="fade-up" data-aos-delay="{{ forloop.counter|add:2 }}0">
                    <td data-column="sno">
                        <span style="font-weight: 600; color: var(--zoho-text-muted);">{{ forloop.counter }}</span>
                    </td>
                    <td data-column="project">
                        <span style="font-weight: 500; color: var(--zoho-accent);">{{ log.PROJECT_TITLE }}</span>
                    </td>
                    <td data-column="heading">
                        <span style="color: var(--zoho-text-primary);">{{ log.LOG_HEADING|truncatechars:50 }}</span>
                    </td>
                    <td data-column="date">
                        {{ log.LOG_DATE|date:"d M, Y" }}
                    </td>
                    <td data-column="session">
                        <span class="log-session-badge {% if log.SESSION_TYPE == 'First Half' %}first-half{% else %}second-half{% endif %}">
                            <i class="bi bi-{% if log.SESSION_TYPE == 'First Half' %}sun{% else %}moon{% endif %}"></i>
                            {{ log.SESSION_TYPE }}
                        </span>
                    </td>
                    <td data-column="action">
                        <button class="view-log-btn" onclick="viewLog({{ log.ID }})">
                            <i class="bi bi-eye"></i>
                            View
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">
                        <div class="zoho-empty-state">
                            <div class="zoho-empty-icon">
                                <i class="bi bi-journal-x"></i>
                            </div>
                            <h3 class="zoho-empty-title">No Logs Found</h3>
                            <p class="zoho-empty-text">
                                {% if is_current_month %}
                                    You haven't added any logs for {{ month_name }} yet.
                                {% else %}
                                    No logs were recorded in {{ month_name }} {{ year }}.
                                {% endif %}
                            </p>
                            {% if is_current_month %}
                            <button class="zoho-btn zoho-btn-primary" onclick="openAddLogForm('{{ current_date }}', '{{ current_date_display }}')">
                                <i class="bi bi-plus-lg"></i>
                                Add Your First Log
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/draggable-table.js' %}"></script>
<script>
    // Pass user projects to JavaScript for autocomplete
    window.userProjects = [{% for project in user_projects %}"{{ project }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    
    // Initialize draggable table
    let logsTable;
    document.addEventListener('DOMContentLoaded', function() {
        logsTable = initDraggableTable('logsTable', 'logs');
    });
</script>
{% endblock %}
